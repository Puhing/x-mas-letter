<%-include('header.ejs')%>
<style>body{background-color: #0D5394;}</style>
<div class="mailbox-page">
    <div class="bottom_ground"></div>
    <div class="street_lamp"></div>
    <div class="mailbox-con">
        <div class="top-div">
            <div class="title">ë‹˜ì˜ ìš°ì²´í†µ</div>
            <div class="sub-title" id="mailcount">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš”.</div>
        </div>
        <div class="mailbox"><img src="/img/img_mailbox.png" /></div>
        <div class="btm-btns" id="my-mailbox">
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(1)">ìš°ì²´í†µ ê³µìœ í•˜ê¸°</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(2)">í¸ì§€ ì—´ê¸°</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(3)">QWER ë©¤ë²„ë“¤ì—ê²Œ í¸ì§€ë°›ê¸°</div>
        </div>
        <div class="btm-btns vertical" id="other-mailbox">
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(5)">í¸ì§€ ë‚¨ê¸°ê¸°</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(4)">ë‚˜ì˜ ìš°ì²´í†µ ë§Œë“¤ê¸°</div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-qwer1">
        <div class="btm-con">
            <div class="contents">QWER ë©¤ë²„ë“¤ì´ ë³´ë‚´ëŠ” ìŠ¤í˜ì…œ í¸ì§€! í•˜ë£¨ì— ìµœëŒ€ í•œê°œê¹Œì§€ ë°›ì„ ìˆ˜ ìˆìœ¼ë©°, ë©¤ë²„ë³„ë¡œ 1ì¥, ë‹¨ì²´ 1ì¥ ì´ 5ì¥ì´ ì¤€ë¹„ë˜ì–´ ìˆì–´ìš”</div>
            <div class="btns">
                <div class="btn" onclick="onClickGetQWER()">ë°›ì„ë˜ìš”</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-qwer2">
        <div class="btm-con">
            <div class="contents"></div>
            <div class="btns">
                <div class="btn" onclick="onClickGoDiscord()"><img src="/img/sns/youtube.png?v=1"> Discord</div>
                <div class="btn" onclick="onClickThankyou()">ê³ ë§ˆì›Œìš”</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-not-yet">
        <div class="btm-con">
            <div class="contents">ë°›ì€ í¸ì§€ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë•Œ ë³¼ ìˆ˜ ìˆì–´ìš”!</div>
            <div class="btns">
                <div class="btn" onclick="closeAllPopup()">ë‹«ê¸°</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-share">
        <div class="btm-con">
            <div class="contents">
                <div class="title">ë‚´ ìš°ì²´í†µì„ ê³µìœ í•´ë³´ì„¸ìš”!</div>
                <div class="buttons">
                    <div id="mylink"><img src="/img/sns/link.png" /></div>
                    <div onclick="shareTwitter()"><img src="/img/sns/x.png" /></div>
                    <div onclick="shareFacebook()"><img src="/img/sns/fb.png" /></div>
                    <div onclick="shareKakao()"><img src="/img/sns/kakao.png" /></div>
                    <div onclick="shareBand()"><img src="/img/sns/band.png" /></div>
                </div>
            </div>
            <div class="btns">
                <div class="btn" onclick="closeAllPopup()">ë‹«ê¸°</div>
            </div>
        </div>
    </div>
</div>
<script>
    var userId = getCookie('userId');
    const url = new URL(location.href);
    var nickname, email, visit;
    var myVisit = '';
    var letter_count = 0;
    window.onload = function () {
        visit = url.searchParams.get('visit');
        if (visit) {
            $.ajax({
                url: '/mailbox/user_check',
                async: true,
                type: 'GET',
                data: {
                    user: visit,
                },
                success: function (data) {
                    $('#other-mailbox').addClass('open');

                    $('.title')[0].innerHTML = data.user.nickname + 'ë‹˜ì˜ ìš°ì²´í†µ';
                    $('#mailcount')[0].innerHTML = data.mail + 'ê°œì˜ í¸ì§€ê°€ ë„ì°©í–ˆì–´ìš”!';
                    letter_count = data.mail;
                },
                error: function (err) {
                    alert('FAILURE : ', err.msg);
                    window.location.href = '/';
                },
            });
        } else {
            $.ajax({
                url: '/user/handshake',
                async: true,
                type: 'POST',
                data: {
                    userId: userId,
                },
                dataType: 'json',
                success: function (data) {
                    if (data.status == 1) {
                        nickname = data.user.nickname;
                        email = data.user.email;
                        myVisit = data.user.uuid;

                        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=copy&utm_medium=social&utm_campaign=x-mas`;
                        $('#mylink').attr('data-clipboard-text', link);
                        $('.title')[0].innerHTML = nickname + 'ë‹˜ì˜ ìš°ì²´í†µ';
                        $('#mailcount')[0].innerHTML = data.mail + 'ê°œì˜ í¸ì§€ê°€ ë„ì°©í–ˆì–´ìš”!';
                        $('#my-mailbox').addClass('open');
                        letter_count = data.mail;

                        var clipboard = new ClipboardJS('#mylink');
                        clipboard.on('success', function () {
                            etag_mailbox_share('link');
                            alert('ğŸ“® ìš°ì²´í†µ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        });
                        clipboard.on('error', function () {
                            alert('Fail');
                        });
                    } else {
                        alert(data.msg);
                        window.location.href = '/';
                    }
                },
                error: function (err) {
                    alert('FAILURE : ', err.msg);
                    window.location.href = '/';
                },
            });
        }
    };
    function onClickMailboxBtmBtn(idx) {
        if (idx == 1) {
            // ìš°ì²´í†µ ê³µìœ í•˜ê¸°
        } else if (idx == 2) {
            // í¸ì§€ì—´ê¸°
            location.href = '/reader';
        } else if (idx == 3) {
            // qwer í¸ì§€ë°›ê¸°
            $('#popup-qwer1').addClass('open');
        } else if (idx == 4) {
            // ìš°ì²´í†µ ë§Œë“¤ê¸°
            etag_mailbox_create(letter_count)
            location.href = '/';
        } else if (idx == 5) {
            // í¸ì§€ ë‚¨ê¸°ê¸°
            etag_mailbox_send(letter_count);
            location.href = '/message?visit=' + visit;
        }
    }

    function openPopup(id) {
        $(id).addClass('open');
        setTimeout(function () {
            $(id + ' .btm-con').addClass('open');
        }, 10);
    }

    function closePopup(id) {
        $(id + ' .btm-con').removeClass('open');
        setTimeout(function () {
            console.log(id);
            $(id).removeClass('open');
        }, 300);
    }

    function closeAllPopup() {
        let rs = $('.mailbox-btm-popup.open').toArray();
        for (let r of rs) {
            closePopup('#' + $(r).attr('id'));
        }
    }

    function onClickMailboxBtmBtn(idx) {
        if (idx == 1) {
            // ìš°ì²´í†µ ê³µìœ í•˜ê¸°
            etag_mailbox_share_click();
            openPopup('#popup-share');
        } else if (idx == 2) {
            // í¸ì§€ì—´ê¸°
            etag_mailbox_open();
            openPopup('#popup-not-yet');
        } else if (idx == 3) {
            // qwer í¸ì§€ë°›ê¸°
            etag_mailbox_qwer(letter_count);
            openPopup('#popup-qwer1');
        } else if (idx == 4) {
            // ìš°ì²´í†µ ë§Œë“¤ê¸°
            location.href = '/';
        } else if (idx == 5) {
            // í¸ì§€ ë‚¨ê¸°ê¸°
            location.href = '/message?visit=' + visit;
        }
    }

    function onClickThankyou(){
        etag_mailbox_qwer_thankyou();
        closeAllPopup();
    }

    let todaywho = "";
    function onClickGetQWER() {
        etag_mailbox_qwer_apply(letter_count);

        closePopup('#popup-qwer1');
        openPopup('#popup-qwer2');

        $.ajax({
            url: '/mailbox/get_qwer',
            async: true,
            type: 'POST',
            data: {
                userId: userId,
            },
            dataType: 'json',
            success: function (data) {
                let arr = ["Q", "W", "E", "R", "ë‹¨ì²´"]
                todaywho = arr[data.today];
                if (data.status == 1) {
                    $('#popup-qwer2 .contents')[0].innerHTML = `[${arr[data.more]}]ì˜ í¸ì§€ê°€ í¸ì§€í•¨ì— ë¨¼ì € ë„ì°©í–ˆì–´ìš”!<br>ë‚´ì¼ ë˜ ë°›ì„ ìˆ˜ ìˆì–´ìš”. :)<br>(ë°›ì€ í¸ì§€ : ${data.cnt}/5)`;
                } else if (data.status == 0) {
                    $('#popup-qwer2 .contents')[0].innerHTML = `ì˜¤ëŠ˜ì˜ QWER í¸ì§€ëŠ” ì´ë¯¸ ì‹ ì²­í–ˆì–´ìš”!<br>ë‚´ì¼ ë˜ ë°›ì„ ìˆ˜ ìˆì–´ìš”!<br>(ë°›ì€ í¸ì§€ : ${data.cnt}/5)`;
                } else if (data.status == -2) {
                    todaywho = "ALL"
                    $('#popup-qwer2 .contents')[0].innerHTML = `5ë²ˆì˜ í¸ì§€ ì‹ ì²­ì„ ëª¨ë‘ í–ˆì–´ìš”!<br>(ë°›ì€ í¸ì§€ : ${data.cnt}/5)`;
                }
            },
            error: function (err) {
                alert('FAILURE : ', err.msg);
            },
        });
        $('#popup-qwer2 .contents')[0].innerHTML = "ì‹ ì²­ ì¤‘...."
    }

    function onClickGoDiscord() {
        etag_mailbox_qwer_view(todaywho);
        window.open('https://youtu.be/WGm2HmXeeRI?feature=shared', '_blank');
    }

    function shareFacebook() {
        etag_mailbox_share('facebook');

        var fburl = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=fb&utm_medium=social&utm_campaign=x-mas`;
        var fbtitle = 'ğŸ“®í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í¸ì§€ğŸ“®';
        var fbsummary = 'ë‚˜ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìš°ì²´í†µì— í¸ì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! ë³´ë‚´ì£¼ì‹  í¸ì§€ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ğŸ… ';
        var sharerURL =
            'http://www.facebook.com/sharer/sharer.php?s=100&p[url]=' +
            encodeURI(fburl) +
            '&p[title]=' +
            encodeURI(fbtitle) +
            '&p[summary]=' +
            encodeURI(fbsummary);
        window.open(sharerURL, 'facebook-share-dialog', 'width=626,height=436');
    }

    function shareKakao() {
        etag_mailbox_share('kakao');

        const text = `ë‚˜ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìš°ì²´í†µì— í¸ì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! ë³´ë‚´ì£¼ì‹  í¸ì§€ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ğŸ… `;
        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=kakao&utm_medium=social&utm_campaign=x-mas`;
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: 'ğŸ“®í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í¸ì§€ğŸ“®',
                description: text,
                imageUrl: 'https://xmasletter.kr/img/thumb.png',
                link: {
                    mobileWebUrl: link,
                    webUrl: link,
                },
            },
        });
    }

    function shareBand() {
        etag_mailbox_share('band');

        const text = `ğŸ“®í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í¸ì§€ğŸ“®\në‚˜ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìš°ì²´í†µì— í¸ì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! ë³´ë‚´ì£¼ì‹  í¸ì§€ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ğŸ… `;
        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=band&utm_medium=social&utm_campaign=x-mas`;
        window.open(
            `https://band.us/plugin/share?body=${encodeURIComponent(text)}&route=${encodeURIComponent(link)}`,
            'band-share-dialog',
            'width=626,height=436'
        );
    }

    function shareTwitter() {
        etag_mailbox_share('twitter');
        const text = `ğŸ“®í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í¸ì§€ğŸ“®\në‚˜ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìš°ì²´í†µì— í¸ì§€ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! ë³´ë‚´ì£¼ì‹  í¸ì§€ëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì— í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ğŸ… https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=twitter&utm_medium=social&utm_campaign=x-mas`;

        window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(text), 'twitter-share-dialog', 'width=626,height=436');
    }

    etag_mailbox_pageview(letter_count, userId ? "yes" : "no");
</script>
<%-include('footer.ejs')%>
