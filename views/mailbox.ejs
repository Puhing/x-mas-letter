<%-include('header.ejs')%>
<style>body{background-color: #0D5394;}</style>
<div class="mailbox-page">
    <div class="bottom_ground"></div>
    <div class="street_lamp"></div>
    <div class="mailbox-con">
        <div class="top-div">
            <div class="title">님의 우체통</div>
            <div class="sub-title" id="mailcount">아직 도착한 편지가 없어요.</div>
        </div>
        <div class="mailbox"><img src="/img/img_mailbox.png" /></div>
        <div class="btm-btns" id="my-mailbox">
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(1)">우체통 공유하기</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(2)">편지 열기</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(3)">QWER 멤버들에게 편지받기</div>
        </div>
        <div class="btm-btns vertical" id="other-mailbox">
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(5)">편지 남기기</div>
            <div class="xmas-button" onclick="onClickMailboxBtmBtn(4)">나의 우체통 만들기</div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-qwer1">
        <div class="btm-con">
            <div class="contents">QWER 멤버들이 보내는 스페셜 편지! 하루에 최대 한개까지 받을 수 있으며, 멤버별로 1장, 단체 1장 총 5장이 준비되어 있어요</div>
            <div class="btns">
                <div class="btn" onclick="onClickGetQWER()">받을래요</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-qwer2">
        <div class="btm-con">
            <div class="contents"></div>
            <div class="btns">
                <div class="btn" onclick="onClickGoDiscord()"><img src="/img/sns/youtube.png?v=1"> Discord</div>
                <div class="btn" onclick="onClickThankyou()">고마워요</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-not-yet">
        <div class="btm-con">
            <div class="contents">받은 편지는 크리스마스 때 볼 수 있어요!</div>
            <div class="btns">
                <div class="btn" onclick="closeAllPopup()">닫기</div>
            </div>
        </div>
    </div>

    <div class="mailbox-btm-popup" id="popup-share">
        <div class="btm-con">
            <div class="contents">
                <div class="title">내 우체통을 공유해보세요!</div>
                <div class="buttons">
                    <div id="mylink"><img src="/img/sns/link.png" /></div>
                    <div onclick="shareTwitter()"><img src="/img/sns/x.png" /></div>
                    <div onclick="shareFacebook()"><img src="/img/sns/fb.png" /></div>
                    <div onclick="shareKakao()"><img src="/img/sns/kakao.png" /></div>
                    <div onclick="shareBand()"><img src="/img/sns/band.png" /></div>
                </div>
            </div>
            <div class="btns">
                <div class="btn" onclick="closeAllPopup()">닫기</div>
            </div>
        </div>
    </div>
</div>
<script>
    var userId = getCookie('userId');
    const url = new URL(location.href);
    var nickname, email, visit;
    var myVisit = '';
    var letter_count = 0;
    window.onload = function () {
        visit = url.searchParams.get('visit');
        if (visit) {
            $.ajax({
                url: '/mailbox/user_check',
                async: true,
                type: 'GET',
                data: {
                    user: visit,
                },
                success: function (data) {
                    $('#other-mailbox').addClass('open');

                    $('.title')[0].innerHTML = data.user.nickname + '님의 우체통';
                    $('#mailcount')[0].innerHTML = data.mail + '개의 편지가 도착했어요!';
                    letter_count = data.mail;
                },
                error: function (err) {
                    alert('FAILURE : ', err.msg);
                    window.location.href = '/';
                },
            });
        } else {
            $.ajax({
                url: '/user/handshake',
                async: true,
                type: 'POST',
                data: {
                    userId: userId,
                },
                dataType: 'json',
                success: function (data) {
                    if (data.status == 1) {
                        nickname = data.user.nickname;
                        email = data.user.email;
                        myVisit = data.user.uuid;

                        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=copy&utm_medium=social&utm_campaign=x-mas`;
                        $('#mylink').attr('data-clipboard-text', link);
                        $('.title')[0].innerHTML = nickname + '님의 우체통';
                        $('#mailcount')[0].innerHTML = data.mail + '개의 편지가 도착했어요!';
                        $('#my-mailbox').addClass('open');
                        letter_count = data.mail;

                        var clipboard = new ClipboardJS('#mylink');
                        clipboard.on('success', function () {
                            etag_mailbox_share('link');
                            alert('📮 우체통 주소가 복사되었습니다!');
                        });
                        clipboard.on('error', function () {
                            alert('Fail');
                        });
                    } else {
                        alert(data.msg);
                        window.location.href = '/';
                    }
                },
                error: function (err) {
                    alert('FAILURE : ', err.msg);
                    window.location.href = '/';
                },
            });
        }
    };
    function onClickMailboxBtmBtn(idx) {
        if (idx == 1) {
            // 우체통 공유하기
        } else if (idx == 2) {
            // 편지열기
            location.href = '/reader';
        } else if (idx == 3) {
            // qwer 편지받기
            $('#popup-qwer1').addClass('open');
        } else if (idx == 4) {
            // 우체통 만들기
            etag_mailbox_create(letter_count)
            location.href = '/';
        } else if (idx == 5) {
            // 편지 남기기
            etag_mailbox_send(letter_count);
            location.href = '/message?visit=' + visit;
        }
    }

    function openPopup(id) {
        $(id).addClass('open');
        setTimeout(function () {
            $(id + ' .btm-con').addClass('open');
        }, 10);
    }

    function closePopup(id) {
        $(id + ' .btm-con').removeClass('open');
        setTimeout(function () {
            console.log(id);
            $(id).removeClass('open');
        }, 300);
    }

    function closeAllPopup() {
        let rs = $('.mailbox-btm-popup.open').toArray();
        for (let r of rs) {
            closePopup('#' + $(r).attr('id'));
        }
    }

    function onClickMailboxBtmBtn(idx) {
        if (idx == 1) {
            // 우체통 공유하기
            etag_mailbox_share_click();
            openPopup('#popup-share');
        } else if (idx == 2) {
            // 편지열기
            etag_mailbox_open();
            openPopup('#popup-not-yet');
        } else if (idx == 3) {
            // qwer 편지받기
            etag_mailbox_qwer(letter_count);
            openPopup('#popup-qwer1');
        } else if (idx == 4) {
            // 우체통 만들기
            location.href = '/';
        } else if (idx == 5) {
            // 편지 남기기
            location.href = '/message?visit=' + visit;
        }
    }

    function onClickThankyou(){
        etag_mailbox_qwer_thankyou();
        closeAllPopup();
    }

    let todaywho = "";
    function onClickGetQWER() {
        etag_mailbox_qwer_apply(letter_count);

        closePopup('#popup-qwer1');
        openPopup('#popup-qwer2');

        $.ajax({
            url: '/mailbox/get_qwer',
            async: true,
            type: 'POST',
            data: {
                userId: userId,
            },
            dataType: 'json',
            success: function (data) {
                let arr = ["Q", "W", "E", "R", "단체"]
                todaywho = arr[data.today];
                if (data.status == 1) {
                    $('#popup-qwer2 .contents')[0].innerHTML = `[${arr[data.more]}]의 편지가 편지함에 먼저 도착했어요!<br>내일 또 받을 수 있어요. :)<br>(받은 편지 : ${data.cnt}/5)`;
                } else if (data.status == 0) {
                    $('#popup-qwer2 .contents')[0].innerHTML = `오늘의 QWER 편지는 이미 신청했어요!<br>내일 또 받을 수 있어요!<br>(받은 편지 : ${data.cnt}/5)`;
                } else if (data.status == -2) {
                    todaywho = "ALL"
                    $('#popup-qwer2 .contents')[0].innerHTML = `5번의 편지 신청을 모두 했어요!<br>(받은 편지 : ${data.cnt}/5)`;
                }
            },
            error: function (err) {
                alert('FAILURE : ', err.msg);
            },
        });
        $('#popup-qwer2 .contents')[0].innerHTML = "신청 중...."
    }

    function onClickGoDiscord() {
        etag_mailbox_qwer_view(todaywho);
        window.open('https://youtu.be/WGm2HmXeeRI?feature=shared', '_blank');
    }

    function shareFacebook() {
        etag_mailbox_share('facebook');

        var fburl = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=fb&utm_medium=social&utm_campaign=x-mas`;
        var fbtitle = '📮크리스마스 편지📮';
        var fbsummary = '나의 크리스마스 우체통에 편지를 남겨주세요! 보내주신 편지는 크리스마스에 확인할 수 있어요. 🎅 ';
        var sharerURL =
            'http://www.facebook.com/sharer/sharer.php?s=100&p[url]=' +
            encodeURI(fburl) +
            '&p[title]=' +
            encodeURI(fbtitle) +
            '&p[summary]=' +
            encodeURI(fbsummary);
        window.open(sharerURL, 'facebook-share-dialog', 'width=626,height=436');
    }

    function shareKakao() {
        etag_mailbox_share('kakao');

        const text = `나의 크리스마스 우체통에 편지를 남겨주세요! 보내주신 편지는 크리스마스에 확인할 수 있어요. 🎅 `;
        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=kakao&utm_medium=social&utm_campaign=x-mas`;
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: '📮크리스마스 편지📮',
                description: text,
                imageUrl: 'https://xmasletter.kr/img/thumb.png',
                link: {
                    mobileWebUrl: link,
                    webUrl: link,
                },
            },
        });
    }

    function shareBand() {
        etag_mailbox_share('band');

        const text = `📮크리스마스 편지📮\n나의 크리스마스 우체통에 편지를 남겨주세요! 보내주신 편지는 크리스마스에 확인할 수 있어요. 🎅 `;
        const link = `https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=band&utm_medium=social&utm_campaign=x-mas`;
        window.open(
            `https://band.us/plugin/share?body=${encodeURIComponent(text)}&route=${encodeURIComponent(link)}`,
            'band-share-dialog',
            'width=626,height=436'
        );
    }

    function shareTwitter() {
        etag_mailbox_share('twitter');
        const text = `📮크리스마스 편지📮\n나의 크리스마스 우체통에 편지를 남겨주세요! 보내주신 편지는 크리스마스에 확인할 수 있어요. 🎅 https://xmasletter.kr/mailbox?visit=${myVisit}&utm_source=twitter&utm_medium=social&utm_campaign=x-mas`;

        window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(text), 'twitter-share-dialog', 'width=626,height=436');
    }

    etag_mailbox_pageview(letter_count, userId ? "yes" : "no");
</script>
<%-include('footer.ejs')%>
